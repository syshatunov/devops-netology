# Домашнее задание 06-db-06-troobleshooting

<br>

## Задание 1
***Перед выполнением задания ознакомился с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).***

### Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её нужно прервать. Вы как инженер поддержки решили произвести эту операцию:
- **Список операций, которые произведу для остановки запроса пользователя:** напишу небольшой скрипт для поиска и завершения долгих операций:
```
db.currentOp().inprog.forEach(
	function(op) {
		if(op.secs_running > 180) db.killOp(op["opid"]);
	}
)
```
`db.currentOp()` – начинает поиск долгих операций, вернет информацию обо всех активных операциях, выполняемых на сервере MongoDB. Далее отфильтруем все операции выполняющиеся более 180 секунд. `db.killOp()` – завершит операции, по найденным ID.

- **Варианты решения проблемы с долгими (зависающими) запросами в MongoDB:** для начала надо найти причину зависания операций, ей могут быть большой объём данных, сложносоставные запросы, наличие блокирующих операций. Необходимо рассмотреть варианты оптимизации индексов (перестроение), масштабирование кластера (горизонтально или вертикально) и возможность ограничения времени выполнения операции `maxTimeMS()`.
<br>


## Задание 2
***Перед выполнением задания ознакомился с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).***

### Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса. 
**При масштабировании сервиса до N реплик вы увидели, что:**
- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

### Как вы думаете, в чём может быть проблема?
В сервисе используется механизм TTL в Redis, это значит, что в базе остаются записи, которые необходимо удалять одним из методов (**активным** или **ленивым**).<br><br>
**Активный способ** – удаляет устаревшие записи каждые 100 мс.<br>
**Ленивый метод** – удаляет устаревшие записи по запросу.<br><br>
На основе условий задачи можно сделать **вывод**, что в базе накопилось много устаревших записей и Redis не успевает их удалять. По этой же причине Redis заблокировал операции записи.
<br>


## Задание 3
### Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

### Как вы думаете, почему это начало происходить и как локализовать проблему?
Подобные ошибки могут возникать из-за проблем с производительностью СУБД.<br>
Из условий задания мы видим, что проблема возникает при увеличении числа записей в БД. Необходимо проверить лог сервера на предмет ошибок, предупреждений, проверить производительность СУБД.

### Какие пути решения этой проблемы вы можете предложить?
- Увеличить значения некоторых таймаутов СУБД: `connect_timeout`, `interactive_timeout`, `net_read_timeout`, `wait_timeout`.
- Масштабировать кластер СУБД (вертикально или горизонтально).
- Найти долгие запросы, создать индексы, передать подробности инцидента разработчикам для устранения на стороне приложения.
<br>


## Задание 4
### Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объёмом данных лучше, чем MySQL. После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что: `postmaster invoked oom-killer`

### Как вы думаете, что происходит?
Причина в недостаточном объёме ОЗУ, в ОС существует процесс **Out-Of-Memory Killer**, который завершает процессы утилизирующие память, чтобы предотвратить падение всей системы.

### Как бы вы решили эту проблему?
Необходимо проверить лог событий PostgreSQL, выявить наличие ошибок в конфигурации сервера СУБД.<br><br>
Для предотвращения сбоев, необходимо увеличить объем ОЗУ.<br><br>
В файле конфигурации PostgreSQL установить максимальное значение оперативной памяти, которое будет доступно для сервера СУБД.
<br>
